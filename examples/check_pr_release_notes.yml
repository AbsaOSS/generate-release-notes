name: Check Release Notes in PR description

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, labeled, unlabeled]
    branches: [ master ]

jobs:
  check-release-notes:
    runs-on: {your-runner}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Pull Request Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.payload.pull_request.number;
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });
            const labels = pr.data.labels ? pr.data.labels.map(label => label.name) : [];
            
            // Check if "skip-release-notes-check" label is present
            if (labels.includes("skip-release-notes-check")) {
              console.log("Skipping release notes check because 'skip-release-notes-check' label is present.");
              core.setOutput("skip_check", 'true');
              return;
            }

            const pr_body = pr.data.body;
            if (!pr_body) {
              core.setFailed("Pull request description is empty.");
              core.setOutput("pr_body", "");
              core.setOutput("skip_check", 'false');
              return;
            }
            core.setOutput("pr_body", pr_body);
            core.setOutput("skip_check", 'false');
            return;

      - name: Skip check if 'no-release-notes' label is present
        if: steps.pr_info.outputs.skip_check == 'true'
        run: echo "Skipping release notes validation."

      - name: Check for 'Release notes:' and bullet list
        if: steps.pr_info.outputs.skip_check == 'false'
        run: |
          # Extract the body from the previous step
          PR_BODY="${{ steps.pr_info.outputs.pr_body }}"
          
          # Check if "Release notes:" exists
          if ! echo "$PR_BODY" | grep -qi 'release notes:'; then
            echo "Error: 'Release notes:' not found in pull request description."
            exit 1
          fi
          
          # Extract text after "Release notes:" line
          RELEASE_NOTES=$(echo "$PR_BODY" | sed -n '/[Rr]elease.*[Nn]otes/,$p' | tail -n +2)
          
          # Check if there's a bullet list (lines starting with '-' or '*')
          if ! echo "$RELEASE_NOTES" | grep -qE '^\s*[-*]\s+.+$'; then
            echo "Error: No bullet list found under 'Release notes:'."
            exit 1
          fi
